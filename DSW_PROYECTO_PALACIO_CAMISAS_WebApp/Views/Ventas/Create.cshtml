@using DSW_PROYECTO_PALACIO_CAMISAS_WebApp.ViewModels
@model VentaCreate
@{
    ViewData["Title"] = "Registrar Venta";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>@ViewData["Title"]</h2>
    <a asp-action="Index" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i>Volver
    </a>
</div>

@if (TempData["msg"] != null)
{
    <div class="alert alert-@(TempData["tipo"] == "success" ? "success" : "danger") alert-dismissible fade show">
        @TempData["msg"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<form asp-action="Create" method="post">
    <!-- Información del Cliente -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-user me-2"></i>Información del Cliente</h5>
        </div>
        <div class="card-body row g-3">
            <div class="col-md-3">
                <label class="form-label">DNI <span class="text-danger">*</span></label>
                <input asp-for="Dni_Cliente" class="form-control" maxlength="8" pattern="[0-9]{8}" required
                       placeholder="12345678" />
                <span asp-validation-for="Dni_Cliente" class="text-danger"></span>
            </div>
            <div class="col-md-6">
                <label class="form-label">Nombre Completo <span class="text-danger">*</span></label>
                <input asp-for="Nombre_Cliente" class="form-control" required
                       placeholder="Nombres y Apellidos" />
                <span asp-validation-for="Nombre_Cliente" class="text-danger"></span>
            </div>
            <div class="col-md-3">
                <label class="form-label">Tipo de Pago</label>
                <select asp-for="Tipo_Pago" class="form-select">
                    <option value="Efectivo">Efectivo</option>
                    <option value="Tarjeta">Tarjeta</option>
                    <option value="Yape">Yape</option>
                    <option value="Plin">Plin</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Selección de Productos -->
    <div class="card mb-3">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Selección de Productos</h5>
            <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#buscarCamisa">
                <i class="fas fa-search me-1"></i>Buscar Camisa
            </button>
        </div>
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Camisa Seleccionada</label>
                    <div class="input-group">
                        <input asp-for="CamisaSeleccionadaId" class="form-control" readonly
                               placeholder="Use el botón Buscar Camisa" />
                        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#buscarCamisa">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Cantidad</label>
                    <input asp-for="Cantidad" type="number" min="1" max="100" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Precio Unitario (opcional)</label>
                    <div class="input-group">
                        <span class="input-group-text">S/.</span>
                        <input asp-for="PrecioUnitario" type="number" step="0.01" min="0" class="form-control"
                               placeholder="Se tomará precio de venta" />
                    </div>
                </div>
                <div class="col-md-3">
                    <button name="action" value="Agregar" class="btn btn-success w-100" type="submit">
                        <i class="fas fa-plus me-1"></i>Agregar al Carrito
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Carrito de Compras -->
    <div class="card mb-3">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">
                <i class="fas fa-shopping-basket me-2"></i>Carrito de Compras
                @if (Model.Lineas.Any())
                {
                    <span class="badge bg-light text-dark ms-2">@Model.Lineas.Count productos</span>
                }
            </h5>
        </div>
        <div class="card-body p-0">
            @if (Model.Lineas.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="5%">#</th>
                                <th width="25%">Producto</th>
                                <th width="20%">Presentación</th>
                                <th width="10%" class="text-center">Cantidad</th>
                                <th width="15%" class="text-end">Precio Unit.</th>
                                <th width="15%" class="text-end">Subtotal</th>
                                <th width="10%" class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.Lineas.Count; i++)
                            {
                                <tr>
                                    <td>@(i + 1)</td>
                                    <td>
                                        <strong>@Model.Lineas[i].Descripcion</strong>
                                    </td>
                                    <td>
                                        <small class="text-muted">@Model.Lineas[i].Presentacion</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-primary">@Model.Lineas[i].Cantidad</span>
                                    </td>
                                    <td class="text-end">S/. @Model.Lineas[i].PrecioUnitario.ToString("N2")</td>
                                    <td class="text-end">
                                        <strong>S/. @Model.Lineas[i].Subtotal.ToString("N2")</strong>
                                    </td>
                                    <td class="text-center">
                                        <button name="action" value="Quitar:@i" class="btn btn-sm btn-outline-danger" type="submit"
                                                onclick="return confirm('¿Quitar este producto del carrito?')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th colspan="5" class="text-end h5 mb-0">TOTAL:</th>
                                <th class="text-end h4 text-success mb-0">S/. @Model.Total.ToString("N2")</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">El carrito está vacío</h5>
                    <p class="text-muted">Use el botón "Buscar Camisa" para agregar productos</p>
                </div>
            }
        </div>
    </div>

    <!-- Botones de Acción -->
    <div class="d-flex justify-content-between">
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-times me-1"></i>Cancelar
        </a>
        <button type="submit" class="btn btn-primary btn-lg" @(Model.Lineas.Any() ? "" : "disabled")>
            <i class="fas fa-save me-1"></i>Registrar Venta
            @if (Model.Lineas.Any())
            {
                <span class="badge bg-light text-dark ms-2">S/. @Model.Total.ToString("N2")</span>
            }
        </button>
    </div>

    <div asp-validation-summary="All" class="text-danger mt-3"></div>
</form>

<!-- Modal Buscar Camisa -->
<div class="modal fade" id="buscarCamisa" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>Buscar y Seleccionar Camisa
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Filtros de Búsqueda -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-filter me-1"></i>Filtros de Búsqueda</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-2">
                                <label class="form-label">Marca</label>
                                <select id="f_marcaId" class="form-select" asp-items="ViewBag.Marcas">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Descripción</label>
                                <input id="f_tipo" class="form-control" placeholder="Descripción" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Talla</label>
                                <input id="f_talla" class="form-control" placeholder="S, M, L, XL" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Manga</label>
                                <input id="f_manga" class="form-control" placeholder="Corta, Larga" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Color</label>
                                <input id="f_color" class="form-control" placeholder="Color" />
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button class="btn btn-primary w-100" type="button" onclick="buscar()">
                                    <i class="fas fa-search me-1"></i>Buscar
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="limpiarFiltros()">
                                <i class="fas fa-eraser me-1"></i>Limpiar Filtros
                            </button>
                            <button class="btn btn-outline-info btn-sm" type="button" onclick="cargarTodas()">
                                <i class="fas fa-list me-1"></i>Mostrar Todas
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Resultados -->
                <div id="resultadoCamisas">
                    <div class="text-center py-4">
                        <i class="fas fa-search fa-2x text-muted mb-2"></i>
                        <p class="text-muted">Use los filtros de arriba y presione "Buscar" para encontrar camisas</p>
                        <button class="btn btn-outline-primary" onclick="cargarTodas()">
                            <i class="fas fa-list me-1"></i>Mostrar Todas las Camisas
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Función para buscar camisas con filtros
        function buscar() {
            const params = new URLSearchParams({
                MarcaId: document.getElementById('f_marcaId').value || '',
                Tipo: document.getElementById('f_tipo').value || '',
                Talla: document.getElementById('f_talla').value || '',
                Manga: document.getElementById('f_manga').value || '',
                Color: document.getElementById('f_color').value || ''
            });

            // Mostrar loading
            document.getElementById('resultadoCamisas').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="text-muted mt-2">Buscando camisas...</p>
                </div>
            `;

            fetch('/Ventas/BuscarCamisas?' + params.toString())
                .then(response => {
                    if (!response.ok) throw new Error('Error en la búsqueda');
                    return response.text();
                })
                .then(html => {
                    document.getElementById('resultadoCamisas').innerHTML = html;
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('resultadoCamisas').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error al buscar camisas. Intente nuevamente.
                        </div>
                    `;
                });
        }

        // Función para cargar todas las camisas
        function cargarTodas() {
            limpiarFiltros();
            buscar();
        }

        // Función para limpiar filtros
        function limpiarFiltros() {
            document.getElementById('f_marcaId').value = '';
            document.getElementById('f_tipo').value = '';
            document.getElementById('f_talla').value = '';
            document.getElementById('f_manga').value = '';
            document.getElementById('f_color').value = '';
        }

        // Función llamada desde el partial para seleccionar camisa
        function seleccionarCamisa(id, descripcion, precio) {
            // Llenar campos del formulario principal
            const inputCamisa = document.querySelector('input[name="CamisaSeleccionadaId"]');
            const inputPrecio = document.querySelector('input[name="PrecioUnitario"]');

            inputCamisa.value = id;
            if (precio > 0) {
                inputPrecio.value = precio.toFixed(2);
            }

            // Cerrar modal
            const modalEl = document.getElementById('buscarCamisa');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            // Mostrar mensaje de confirmación
            inputCamisa.classList.add('is-valid');
            setTimeout(() => {
                inputCamisa.classList.remove('is-valid');
            }, 2000);
        }

        // Cargar todas las camisas al abrir el modal
        document.getElementById('buscarCamisa').addEventListener('shown.bs.modal', function () {
            const resultado = document.getElementById('resultadoCamisas');
            if (resultado.innerHTML.includes('Mostrar Todas las Camisas')) {
                cargarTodas();
            }
        });

        // Permitir buscar con Enter en los campos de filtro
        ['f_marcaId', 'f_tipo', 'f_talla', 'f_manga', 'f_color'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscar();
                }
            });
        });

        // Validación del formulario
        document.querySelector('form').addEventListener('submit', function(e) {
            const action = e.submitter?.value;

            // Si es registrar venta, validar que tenga productos
            if (!action || action === 'Create') {
                const lineas = @Html.Raw(Json.Serialize(Model.Lineas.Count));
                if (lineas === 0) {
                    e.preventDefault();
                    alert('Debe agregar al menos un producto al carrito');
                    return false;
                }

                // Validar datos del cliente
                const dni = document.querySelector('input[name="Dni_Cliente"]').value.trim();
                const nombre = document.querySelector('input[name="Nombre_Cliente"]').value.trim();

                if (!dni || dni.length !== 8) {
                    e.preventDefault();
                    alert('El DNI debe tener 8 dígitos');
                    return false;
                }

                if (!nombre) {
                    e.preventDefault();
                    alert('Complete el nombre del cliente');
                    return false;
                }
            }
        });
    </script>
}