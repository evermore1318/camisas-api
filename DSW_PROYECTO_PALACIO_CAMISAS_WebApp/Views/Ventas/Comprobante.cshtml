@model DSW_PROYECTO_PALACIO_CAMISAS_WebApp.Models.Venta
@{
    ViewData["Title"] = "Comprobante de Venta";
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - @Model.id_venta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @@media print {
            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            body {
                font-size: 12px;
            }

            .card {
                border: 1px solid #000 !important;
                box-shadow: none !important;
            }
        }

        .ticket {
            max-width: 400px;
            margin: 0 auto;
            font-family: 'Courier New', monospace;
        }

        .empresa-header {
            text-align: center;
            border-bottom: 2px dashed #000;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .detalle-item {
            border-bottom: 1px dotted #ccc;
            padding: 5px 0;
        }

        .total-section {
            border-top: 2px solid #000;
            margin-top: 10px;
            padding-top: 10px;
            font-weight: bold;
        }

        @@media screen {
            .ticket {
                border: 1px solid #ddd;
                padding: 20px;
                margin: 20px auto;
                background: white;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
            }
        }
    </style>
</head>
<body class="bg-light">

    <div class="container-fluid py-3">
        <!-- Botones de Acción -->
        <div class="text-center mb-3 no-print">
            <div class="btn-group" role="group">
                <button onclick="window.print()" class="btn btn-success">
                    <i class="fas fa-print me-1"></i>Imprimir
                </button>
                <button onclick="window.close()" class="btn btn-secondary">
                    <i class="fas fa-times me-1"></i>Cerrar
                </button>
                <a asp-action="Details" asp-route-id="@Model.id_venta" class="btn btn-info">
                    <i class="fas fa-eye me-1"></i>Ver Detalles
                </a>
                <a asp-action="Index" class="btn btn-primary">
                    <i class="fas fa-list me-1"></i>Volver al Listado
                </a>
            </div>
        </div>

        <!-- Ticket de Venta -->
        <div class="ticket">
            <!-- Encabezado de la Empresa -->
            <div class="empresa-header">
                <h3 class="mb-1"><strong>PALACIO CAMISAS</strong></h3>
                <p class="mb-1">Av. Principal 123 - Lima, Perú</p>
                <p class="mb-1">Teléfono: (01) 123-4567</p>
                <p class="mb-1">RUC: 20123456789</p>
                <div class="mt-2">
                    <strong>BOLETA DE VENTA ELECTRÓNICA</strong><br>
                    <strong>N° @Model.id_venta.ToString().PadLeft(8, '0')</strong>
                </div>
            </div>

            <!-- Información del Cliente y Venta -->
            <div class="mb-3">
                <div class="row">
                    <div class="col-4"><strong>FECHA:</strong></div>
                    <div class="col-8">@Model.fecha.ToString("dd/MM/yyyy")</div>
                </div>
                <div class="row">
                    <div class="col-4"><strong>HORA:</strong></div>
                    <div class="col-8">@Model.fecha.ToString("HH:mm:ss")</div>
                </div>
                <div class="row">
                    <div class="col-4"><strong>CLIENTE:</strong></div>
                    <div class="col-8">@Model.nombre_cliente</div>
                </div>
                <div class="row">
                    <div class="col-4"><strong>DNI:</strong></div>
                    <div class="col-8">@Model.dni_cliente</div>
                </div>
                <div class="row">
                    <div class="col-4"><strong>PAGO:</strong></div>
                    <div class="col-8">@Model.tipo_pago</div>
                </div>
            </div>

            <!-- Línea separadora -->
            <div style="border-top: 1px dashed #000; margin: 15px 0;"></div>

            <!-- Detalles de Productos -->
            <div class="mb-3">
                <div class="text-center mb-2">
                    <strong>DETALLE DE PRODUCTOS</strong>
                </div>

                @if (Model.detalles?.Any() == true)
                {
                    @foreach (var detalle in Model.detalles)
                    {
                        <div class="detalle-item">
                            <div>
                                <strong>@(detalle.camisa_descripcion ?? "Producto")</strong>
                            </div>
                            <div class="small text-muted">
                                @(detalle.marca_nombre ?? "N/A") -
                                @(detalle.camisa_color ?? "N/A") -
                                @(detalle.camisa_talla ?? "N/A") -
                                @(detalle.camisa_manga ?? "N/A")
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>@detalle.cantidad x S/. @detalle.precio.ToString("N2")</span>
                                <span><strong>S/. @((detalle.cantidad * detalle.precio).ToString("N2"))</strong></span>
                            </div>
                        </div>
                    }
                }
            </div>

            <!-- Totales -->
            <div class="total-section">
                @{
                    var subtotal = Model.precio_total / 1.18m;
                    var igv = Model.precio_total - subtotal;
                }

                <div class="d-flex justify-content-between">
                    <span>SUBTOTAL:</span>
                    <span>S/. @subtotal.ToString("N2")</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>IGV (18%):</span>
                    <span>S/. @igv.ToString("N2")</span>
                </div>
                <div class="d-flex justify-content-between" style="font-size: 1.1em; margin-top: 5px;">
                    <span>TOTAL A PAGAR:</span>
                    <span><strong>S/. @Model.precio_total.ToString("N2")</strong></span>
                </div>
            </div>

            <!-- Información Adicional -->
            <div class="mt-3 text-center small">
                <div style="border-top: 1px dashed #000; padding-top: 10px;">
                    <p class="mb-1">
                        <strong>Total de artículos:</strong> @(Model.detalles?.Sum(d => d.cantidad) ?? 0)
                    </p>
                    @if (Model.estado == "Activo")
                    {
                        <p class="mb-1 text-success">
                            <i class="fas fa-check-circle"></i> <strong>VENTA VÁLIDA</strong>
                        </p>
                    }
                    else
                    {
                        <p class="mb-1 text-danger">
                            <i class="fas fa-ban"></i> <strong>VENTA ANULADA</strong>
                        </p>
                    }
                </div>
            </div>

            <!-- Pie de Página -->
            <div class="mt-3 text-center small" style="border-top: 1px dashed #000; padding-top: 10px;">
                <p class="mb-1">¡Gracias por su compra!</p>
                <p class="mb-1">Síguenos en nuestras redes sociales</p>
                <p class="mb-1">@@palacio_camisas</p>
                <div class="mt-2">
                    <small class="text-muted">
                        Sistema generado: @DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss")
                    </small>
                </div>
            </div>

            <!-- QR Code Placeholder (opcional) -->
            <div class="text-center mt-3 no-print">
                <div class="border p-3 d-inline-block">
                    <i class="fas fa-qrcode fa-3x text-muted"></i><br>
                    <small class="text-muted">Código QR<br>para validación</small>
                </div>
            </div>
        </div>

        <!-- Información de Estado (solo en pantalla) -->
        @if (Model.estado == "Anulado")
        {
            <div class="alert alert-danger text-center no-print mt-3" style="max-width: 400px; margin: 0 auto;">
                <h5><i class="fas fa-ban me-2"></i>VENTA ANULADA</h5>
                <p class="mb-0">Este comprobante corresponde a una venta anulada y no tiene validez comercial.</p>
            </div>
        }
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        window.addEventListener('load', function() {
            if (window.location.search.includes('autoprint=true')) {
                setTimeout(() => window.print(), 500);
            }
        });

        window.addEventListener('afterprint', function() {
            if (window.opener) {
                setTimeout(() => window.close(), 1000);
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                window.print();
            }
            if (e.key === 'Escape') {
                if (window.opener) {
                    window.close();
                } else {
                    history.back();
                }
            }
        });
    </script>

</body>
</html>